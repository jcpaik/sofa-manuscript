A _sofa branch tree_ $T$ of rotation angle $\Theta$ is a search tree that gives an upper bound $\mathcal{A}_T$ of the polygonal area $\mathcal{A}_\Theta$ and thus the original upper bound $\mathcal{A}$. 

The procedure $SofaBranch(\Theta)$ takes the finite angle set $\Theta$ and returns a binary tree $T$. The tree $T$ may or may not be a valid 

The procedure $SofaVerify(\Theta, T)$ verifies whether the tree $T$ gives a valid upper bound $\mathcal{A}_T$.

The procedure $SofaProve(\Theta, T, I)$ attempts to prove an inequality $I$ using method of contradiction. If it returns true, then the inequality $I$ is always true. Even if it fails, it does not mean that the inequality is false.

```pseudo
\begin{algorithm}
\caption{SofaProve}
  \begin{algorithmic}
\Function{SofaProve}{$\Theta, T, I$}
	\If{\Call{SofaVerifyTree}{$\Theta, T$}}
	  \ForAll{valid leaf node $(N, \mathbf{p})$ of $T$}
	     \State $\mu \gets$ \Call{QP}{$\mathcal{A}_\mathbf{p}, N \cup \{I^c\}$}
	     \If{$\mu > 2.2195$}
	       \Return \False
	     \EndIf
	  \EndFor
	  \Return \True
	\Else 
	  \Return \False
	\EndIf
  \EndFunction
  \end{algorithmic}
\end{algorithm}
```

It is the 

Fix a finite angle set $\Theta$ with angles $0 = \theta_0 < \dots < \theta_n = \pi/2$ and rotation angle $\pi/2$. Let $K$ be an arbitrary member of $\mathcal{K}_\Theta$. Denote the parts of the polygon $K$.

> __Definition [sofa-polygon-notations].__ Let the index $0 \leq i \leq n$ be arbitrary. Define the following notions for the arbitrary chosen $K \in \mathcal{K}_\Theta$. ^def-sofa-polygon-notations
> 
> - $p_i = p_K(\theta_i)$, $\mathbf{x}_i = \mathbf{x}_K(\theta_i)$, $\mathbf{y}_i = \mathbf{y}_K(\theta_i)$
> - Denote the lines $a_i := a_K(\theta_i)$, $b_i := b_K(\theta_i)$, $c_i := c_K(\theta_i)$, $d_i := d_K(\theta_i)$.
> - With a bit of abuse of notation, we will also define $d_i = c_{n + i}$ for any negative index $-n \leq i < 0$ as well.

The set $\mathcal{K}_\Theta$ is a polytope.

# Coordinate Systems of $S$

A monotone hallway intersection $S$ is completely determined by its cap $K$. So the state of $S$ can be described by any coordinate system representing the cap $K$. There are three coordinate systems we can use for $K$.

- For every $0 \leq i \leq n$, the inner corners $\mathbf{x}_i = (x_i, y_i) \in \mathbb{R}^2$ of the hallways with $\mathbf{x}_0 = (x_0, y_0) = (0, 0)$ and the $y$-coordinate $y_n$ of $\mathbf{x}_n$ equal to zero. With the constraints we have a total of $2n-1$ free coordinates $x_1, \dots, x_n, y_1, \dots, y_{n-1}$ to determine.
- The support function values $p_0, p_1, \dots, p_n$ and $q_0, q_1, \dots, q_n$ of the right and left part of the cap, with constraints $p_0 = p_n = q_0 = 1$. In this coordinate, we have $2n-1$ free values $p_1, \dots, p_{n-1}$ and $q_1, \dots, q_{n}$ to determine.
- The edge lengths $s_0, s_1, \dots, s_{2n}$ of cap $K$, with constraints $\sum_{i=0}^n \cos(\theta_i) s_i = 1$ and $\sum_{i=0}^n \sin(\theta_i) s_{n+i} = 1$ to ensure that the height of $K$ is equal to 1. Using the two equalities, we can eliminate the variables $s_0 = 1 - \sum_{i=1}^n \cos(\theta_i) s_i$ and $s_{2n} = 1 - \sum_{i=0}^{n-1} \sin(\theta_i) s_{n+i}$ and have $2n-1$ free variables $s_1, s_2, \dots, s_{2n-1}$.

All three coordinate systems are convertible to each other. For example, the coordinates of $\mathbf{x}_i$ determine the values $p_i = \mathbf{x}_i \cdot u_i + 1$ and so the lines $a_i = \left\{ z \in \mathbb{R}^2 : z \cdot u_i = p_i \right\}$ and the intersections $A_i = a_{i-1} \cap a_{i}$. The side lengths are then recoverable from the formula $s_i = (A_{i+1} - A_i) \cdot v_i$. In this way, we can express the edge lengths $s_0, s_1, \dots, s_{2n}$ from the coordinates of $\mathbf{x}_0, \mathbf{x}_1, \dots, \mathbf{x}_n$. We can also work the other way and get the coordinates of $\mathbf{x}_i$ from the edge lengths $s_0, s_1, \dots, s_{2n}$. Start with $A_0 = (0, 0)$, and use the formula $A_{i+1} = A_i + s_i v_i$ to retrieve all the vertices $A_0, \dots, A_{2n}$ of $K$, the support function values $p_i = A_i \cdot u_i$ and $q_i = A_{i + n} \cdot v_n$, and then $\mathbf{x}_i = (p_i - 1) u_i + (q_i - 1) v_i$. Note that all the conversions are affine-linear. So any of the three coordinate systems determine a cap $K$. 

`SofaDesigner` chooses the system of support function values $p_1, \dots, p_{n-1}$ and $q_1, \dots, q_{n}$. Let $\mathbf{p} = (p_1, \dots, p_{n-1}, q_1, \dots, q_n)$ be the list of free variables in the given order. We also require each side length $s_i$ to be nonnegative in order for $K$ to be a proper cap. For any $0 \leq i \leq 2n$, let $E_i$ be the inequality $s_i \geq 0$ where $s_i$ is written in terms of $\mathbf{p}$. Define $\mathcal{K}_\Theta$ as the domain of $2n-1$ free real variables $\mathbf{p}$ in support function coordinates with the linear constraints $E_i$ for all $0 \leq i \leq n$. Then $\mathcal{K}_\Theta$ is the space of all caps of monotone hallway intersections with angle set $\Theta$. The goal of `SofaDesigner` is to understand the subset of $\mathcal{K}_\Theta$ where the cap gives rise to the monotone hallway intersection $S = H \cap \bigcap_{i=0}^n L_i$ of area at least $2.2195$.

# Sofa branch tree

> __Definition [sofa-inequality].__ A _sofa inequality_ $I$ is an linear constraint of form $f(K) \leq g(K)$ on the set $\mathcal{K}_\Theta$, where $f, g : \mathcal{K}_\Theta \to \mathbb{R}$ are linear functionals on $\mathcal{K}_\Theta$.
> ^def-sofa-inequality

> __Definition [sofa-inequality-complement].__ For any sofa inequality $I$ which is $f(K) \leq g(K)$, define its _complement_ $I^c$ as $f(K) \geq g(K)$.
> ^def-sofa-inequality-complement

> __Definition [sofa-polytope].__ A _sofa polytope_ $N$ is a finite set of linear inequalities $\left\{ I_1, \dots, I_m \right\}$ on $\mathcal{K}_\Theta$. Define $\mathcal{K}_N$ as the set of all $K \in \mathcal{K}_\Theta$ satisfying every inequalities in $N$.
> ^def-sofa-polytope

> __Definition [polyline].__ A _polyline_ $\mathbf{i}$ is a finite sequence $\mathbf{i} = i_0, \dots, i_m$ of indices with integers $-n < i_j < n$ such that the followings hold. ^def-polyline
> 
> 1. $i_0 = i_m = 0$.
> 2. For any adjacent $i_{j - 1}$, $i_{j}$ with $j > 0$, we have $i_{j - 1} \neq i_j$.
> 3. If $i_{j - 1} > i_{j}$ for $j > 0$, then  $i_j = i_{j-1} - n$.
> 4. For any $1 \leq i < n$, if the numbers $i$ and $i - n$ both appear in $\mathbf{i}$, then all occurences of $i$ in $\mathbf{i}$ is on the left side of all the occurences of $i - n$ in $\mathbf{i}$.

The polyline $\mathbf{i}$ represents the subset of niche $\mathcal{N}(K)$ bounded from below by the line $y=0$ and bounded from above by the sequence of lines $l_{i_0}, l_{i_1}, \dots, l_{i_m}$ with the vertices $v(i_{j - 1}, i_{j})$ appearing from left to right. Condition 1 implies that the initial and final lines are equal to $l_0$, which is the line $y=0$. Condition 2 implies that the vertices $v(i_{j-1}. i_j)$ are well-defined for any $1 \leq j \leq m$. Condition 3 implies that any 'concave' turn from $l_{j - 1}$ to $l_j$ happens at the corner $v(i_{j-1}, i_j) = \mathbf{x}_{i_{j-1}}$ of hallway $L_{i_{j-1}}$. Condition 4 implies that

> __Definition [sofa-node].__ A _sofa node_ is a tuple $(N, \mathbf{p})$ of a sofa polytope $N$ and a polyline $\mathbf{p} = (i_0, \dots, i_m)$, so that the following properties hold for all $K$ in $\mathcal{K}_N$.
> ^def-sofa-node
> 
> - The vertices $v_{\mathbf{p}, 1}, v_{\mathbf{p}, 2}, \dots, v_{\mathbf{p}, m}$ of the polyline $\mathbf{p}$ are in a monotonically increasing order of their $x$-coordinates.
> - Let $1 \leq i < n$ be arbitrary. For any vertex $v$ of the polyline $\mathbf{p}$ with one of the intersection lines $l_i$, the point $v$ is on the left side of the point $\mathbf{x}_i$.
> - For any vertex $v$ of the polyline $\mathbf{p}$ with one of the intersection lines $l_{i - n}$, the point $v$ is on the right side of the point $\mathbf{x}_i$.

> __Definition [sofa-node-area].__ Define $\mathcal{A}_{N, \mathbf{p}} : \mathcal{K}_N \to \mathbb{R}$ as the sum
$$
\mathcal{A}_{N, \mathbf{p}}(K) = |K| - \sum_{j=2}^m \mathcal{I}(v_{\mathbf{p}, j - 1}, v_{\mathbf{p}, j})
$$
> ^def-sofa-node-area

> __Proposition [sofa-node-area].__ Let $(N, \mathbf{p})$ be any sofa state. For any $K \in \mathcal{K}_N$, we have $\mathcal{A}_{N, \mathbf{p}}$
> ^pro-sofa-node-area

> __Definition [sofa-branch-tree].__ A _sofa branch tree_ $T$ with angle set $\Theta$ is a complete bipartite tree such that the followings hold. ^def-sofa-branch-tree
> 
> - Each node is a sofa state.
> - The root node is $(\emptyset, (0))$ representing the whole space $\mathcal{K}_\Theta$.
> - Any non-leaf node of $T$ with sofa polytope $N$ has two childs with sofa polytope $N \cup \left\{ I \right\}$ and $N \cup \left\{ I^c \right\}$ split by a sofa inequality $I$.
> - Every leaf node of $T$ is either _invalid_ or _valid_.
> 	- A invalid node $(N, \mathbf{p})$ 
> 	- A valid node $P$ represents a subset $P \cap \left\{ \mathcal{A}_{\mathbf{i}} \geq 2.2195 \right\}$.



```pseudo
\begin{algorithm}
  \begin{algorithmic}
  \Function{AddCorner}{$\mathbf{p}, i$}
	\If{$\mathbf{x}_i$ is below $l_0$}
	  \Return{$\mathbf{p}$}
	\EndIf 
	\State $i_0, i_1, \dots, i_m \gets \mathbf{p}$
	\For{$j \gets 0$ \To $m - 1$}
	  \If{$j < m$ \And $\mathbf{x}_i$ is on left side of $v(i_j, i_{j+1})$}
	    \If{$\mathbf{x}_i$ is below $l_{i_j}$}
	      \Return{\Call{AddCornerInside}{$\mathbf{p}, i, j$}}
	    \Else
	      \Return{\Call{AddCornerOutside}{$\mathbf{p}, i, j$}}
	    \EndIf
	  \EndIf
	\EndFor
	\Return{\Call{AddCornerOutside}{$\mathbf{p}, i, m$}}
  \EndFunction
  \end{algorithmic}
\end{algorithm}
```

```pseudo
\begin{algorithm}
  \begin{algorithmic}
\Function{AddCornerInside}{$\mathbf{p}, i, j$}
	\State $i_0, i_1, \dots, i_m \gets \mathbf{p}$
	\State $i \gets p - 1$
	\For{$j \gets p$ \To $r - 1$}
	  \If{$A[j] < x$}
		\State $i \gets i + 1$
		\State exchange
		$A[i]$ with $A[j]$
	  \EndIf
	\State exchange $A[i]$ with $A[r]$
	\EndFor
  \EndFunction
  \end{algorithmic}
\end{algorithm}
```

- The procedure generates a claim of tree that we can always verify by verifier.
- The procedure is guaranteed to produce a correct tree, with theoretical proof.