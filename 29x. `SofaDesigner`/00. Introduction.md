Let $\Theta$ be a finite set of angles such that $\{0, \pi/2\} \subseteq \Theta \subseteq [0, \pi/2]$. That is, $\Theta$ is a partition
$$0 = \theta_0 < \theta_1 < \theta_2 < \cdots < \theta_n = \pi/2$$
of the interval $[0, \pi/2]$. The task of `SofaDesigner` is to compute the set of all _monotone hallway intersections_ $S$ with the set of angles $\Theta$ and an area at least $2.2195\dots$. A sofa can be seen as the intersection of rotating hallways. Essentially, $S$ is a polygonal intersection of the finite number of hallways of width 1 rotated by each angle of $\Theta$, approximating a sofa from above.

# Definition of Monotone Hallway Intersection $S$

We first provide the precise definition and shape of a monotone hallway intersection $S$ with angle set $\Theta$. All the details in this section is important.

$H = \mathbb{R} \times [0, 1]$ is the horizontal strip of height 1. $L$ is the right-angled hallway of width 1, with inner corner at $\mathbf{x} = (0, 0)$ and outer corner at $\mathbf{y} = (1, 1)$. Mathematically, $L = (-\infty, 1] \times [0, 1] \cup [0, 1] \times (-\infty, 1]$. Let $a$ and $b$ be the lines $x=1$ and $y=1$ passing through the outer corner $\mathbf{y}$ representing the outer walls of $L$. Let $c$ and $d$ be the half-lines $(-\infty, 0] \times \left\{ 0 \right\}$ and $\left\{ 0 \right\} \times (-\infty, 0]$ emanating from the inner corner $\mathbf{x}$ representing the inner walls of $L$. 

For all $0 \leq i \leq n$, let $u_i = (\cos \theta_i, \sin \theta_i)$ and $v_i = (-\sin \theta_i, \cos \theta_i)$ so that the vectors $u_i$ and $v_i$ form a orthogonal basis. Also, let $v_{i + n} = - u_i$ for all $0 \leq i \leq n$ so that $v_i$ is defined for all indices $i$ from $0$ to $2n$. For any $0 \leq i \leq n$, let $L_i$ be a copy of the hallway $L$ rotated counterclockwise by an angle of $\theta_i$ and translated so that the inner corner is positioned at $\mathbf{x}_i$. Here, the set $S$ is the intersection of the horizontal strip $H$ and the rotated hallways $L_i$. Let $a_i$, $b_i$, $c_i$ and $d_i$ be the sides of the hallway $L_i$ corresponding to the sides $a, b, c,$ and $d$ of $L$.

For the intersection $S = H \cap \bigcap_{i=0}^n L_i$ to be a monotone hallway intersection, we require the following conditions. 

- (WLOG) Without loss of generality, by translating $S$ horizontally we assume that $L_0 = L$ so that $\mathbf{x}_0 = (0, 0)$. Also, we assume that $\mathbf{x}_n$ has the $y$-coordinate equal to zero. Consequently, the sides $a_n$ and $c_0$ are equal to the line $y=1$.
- (Monotonicity) The sides $y=0$ and $y=1$ of $H$ and the outer walls $a_i$ and $c_i$ of $L_i$ for any $0 \leq i \leq n$ should determine all the sides of a convex polygon $K$ called the _cap_ of $S$. Although we allow some edges of $K$ to degenerate and have zero length, all the lines $a_0, a_1, \dots, a_{n-1}, a_n = c_0, c_1, \dots, c_n$, and $y = 0$ should form the edges of $K$ in counterclockwise order.

Consequently, the sides $a_n$ and $c_0$ are equal to the line $y=1$ and determines the upper horizontal edge of $K$. The sides $a_0, a_1, \dots, a_{n-1}$ forms the different edge of $K$ on the right side in counterclockwise order, and the sides $c_1, c_2, \dots, c_n$ forms the different edges of $K$ on the right side in counterclockwise order.

For any $0 < i \leq n$, let $A_i$ be the intersection of $a_{i-1}$ and $a_i$. Also let $A_0$ be the intersection of $a_0$ and the line $y=0$. Likewise, for any $0 \leq i < n$, let $C_i$ be the intersection of $c_i$ and $c_{i+1}$. Also let $C_n$ be the intersection of $a_0$ and the line $y=0$. Then the points $A_0, A_1, \dots, A_n$ forms the vertices of $K$ on the right side, and the points $C_0, C_1, \dots, C_n$ forms the vertices of $K$ on the left side. For any $0 \leq i \leq n$, define $A_{n + 1 + i} = A_i$ so that the list $A_0, A_1, \dots, A_{2n + 1}$ forms all the vertices of $K$ in the counterclockwise order.

For any $0 \leq i \leq n$, define the support function values $p_i = A_i \cdot u_i$ and $q_i = C_i \cdot v_i$ of the cap $K$. Note that we also have $p_i = \mathbf{x}_i \cdot u_i + 1$ and $q_i = \mathbf{x}_i \cdot v_i + 1$. Note that as the sides $a_n$ and $c_0$ are equal to the line $y=1$, we have $p_n = q_0 = 1$. $0 \leq i \leq n$, define $p_{n+i} = q_i$ so that the list $p_0, p_1, \dots, p_{2n}$ is a concatenation of $p_0, p_1, \dots, p_n$ and $q_0, q_1, \dots, q_n$. For every $0 \leq i \leq 2n$, define the side lengths $s_i = (A_{i+1} - A_i) \cdot v_i$ of $K$.

# Coordinate Systems of $S$

A monotone hallway intersection $S$ is completely determined by its cap $K$. So the state of $S$ can be described by any coordinate system representing the cap $K$. There are three coordinate systems we can use for $K$.

- For every $0 \leq i \leq n$, the inner corners $\mathbf{x}_i = (x_i, y_i) \in \mathbb{R}^2$ of the hallways with $\mathbf{x}_0 = (x_0, y_0) = (0, 0)$ and the $y$-coordinate $y_n$ of $\mathbf{x}_n$ equal to zero. With the constraints we have a total of $2n-1$ free coordinates $x_1, \dots, x_n, y_1, \dots, y_{n-1}$ to determine.
- The support function values $p_0, p_1, \dots, p_n$ and $q_0, q_1, \dots, q_n$ of the right and left part of the cap, with constraints $p_0 = p_n = q_n = 1$. In this coordinate, we have $2n-1$ free values $p_1, \dots, p_{n-1}$ and $q_0, \dots, q_{n-1}$ to determine.
- The edge lengths $s_0, s_1, \dots, s_{2n}$ of cap $K$, with constraints $\sum_{i=0}^n \cos(\theta_i) s_i = 1$ and $\sum_{i=0}^n \sin(\theta_i) s_{n+i} = 1$ to ensure that the height of $K$ is equal to 1. Using the two equalities, we can eliminate the variables $s_0 = 1 - \sum_{i=1}^n \cos(\theta_i) s_i$ and $s_{2n} = 1 - \sum_{i=0}^{n-1} \sin(\theta_i) s_{n+i}$ and have $2n-1$ free variables $s_1, s_2, \dots, s_{2n-1}$.

All three coordinate systems are convertible to each other. For example, the coordinates of $\mathbf{x}_i$ determine the values $p_i = \mathbf{x}_i \cdot u_i + 1$ and so the lines $a_i = \left\{ z \in \mathbb{R}^2 : z \cdot u_i = p_i \right\}$ and the intersections $A_i = a_{i-1} \cap a_{i}$. The side lengths are then recoverable from the formula $s_i = (A_{i+1} - A_i) \cdot v_i$. In this way, we can express the edge lengths $s_0, s_1, \dots, s_{2n}$ from the coordinates of $\mathbf{x}_0, \mathbf{x}_1, \dots, \mathbf{x}_n$. We can also work the other way and get the coordinates of $\mathbf{x}_i$ from the edge lengths $s_0, s_1, \dots, s_{2n}$. Start with $A_0 = (0, 0)$, and use the formula $A_{i+1} = A_i + s_i v_i$ to retrieve all the vertices $A_0, \dots, A_{2n}$ of $K$, the support function values $p_i = A_i \cdot u_i$ and $q_i = A_{i + n} \cdot v_n$, and then $\mathbf{x}_i = (p_i - 1) u_i + (q_i - 1) v_i$. Note that all the conversions are affine-linear.

So any of the coordinate systems determine a cap $K$. We also require each side length $s_i$ to be nonnegative in order for $K$ to be a proper cap. For any $0 \leq i \leq 2n$, let $E_i$ be the inequality $s_i \geq 0$. Note that the linear constraint $E_i$ can be expressed in any of the three coordinates. Define $\mathcal{K}_\Theta$ as the domain of $2n-1$ free real variables in support function coordinates with the linear constraints $E_i$ for all $0 \leq i \leq n$. Then $\mathcal{K}_\Theta$ is the space of all caps of monotone hallway intersections with angle set $\Theta$. The goal of `SofaDesigner` is to understand the subset of $\mathcal{K}_\Theta$ where the cap gives rise to the monotone hallway intersection $S = H \cap \bigcap_{i=0}^n L_i$ of area at least $2.2195$.

# Area of $S$ by its Niche $\mathcal{N}(K)$ and its Order $\mathbf{i}_K$

Let $\mathcal{A}(K)$ be the area of the monotone hallway intersection $S$ with cap $K \in \mathcal{K}_\Theta$. The goal of `SofaDesigner` is to understand the area functional $\mathcal{A} : \mathcal{K}_\Theta \to \mathbb{R}$ completely. Define the _niche_ $\mathcal{N}(K)$ of the monotone hallway intersection $S$ as the region bounded from below by the line $y=0$, and bounded from above by the upper envelope of the line $y=0$ and the half-lines $c_i$ and $d_i$ for all $0 \leq i \leq n$. For any set $X$, denote its area as $|X|$. Then the area $|S|$ of $S$ is equal to $\mathcal{A}(K) = |K| - \mathcal{N}(K)$ because $S$ is the cap $K$ subtracted by the union of inner corners $\mathcal{N}(K)$. Note that the area $|K|$ of cap is a quadratic polynomial in terms of the coordinates of $\mathcal{K}_\Theta$ (one can for example use the [shoelace formula](https://mathworld.wolfram.com/ShoelaceFormula.html)). However, the area of the niche $\mathcal{N}(K)$ is much harder to understand.

If the order of edges appearing in the niche $\mathcal{N}(K)$ is determined, we can understand the area $|\mathcal{N}(K)|$ as a quadratic polynomial of the coordinates of $K$. For every $0 \leq i \leq n$, define the line $l_i$ as the line extending the half-line $d_i$, and the line $l_{-i}$ as the line extending the half-line $b_{n-i}$ (note that $l_0$ is equal to the line $y=0$ in both cases). Let $\mathbf{i}_K$ be the list of all the indices $i$ of the lines $l_i$ appearing in the niche $\mathcal{N}(K)$ from left to right. So $\mathbf{i}_K$ is either a list of length one with only one zero, or a list with length at least two starting and ending with zero. If $-n \leq i , j \leq n$ are different indices, define the point $p_{i, j}$ as the intersection of the lines $l_i$ and $l_j$. Then the coordinates of points $p_{i, j}$ are affine-linear with respect to the coordinates of $\mathcal{K}_\Theta$ no matter which coordinate system we take. If $\mathbf{i}_K$ is the list $i_1, i_2, \dots, i_m$, then the vertices of the niche are exactly $p_{i_1, i_2}, p_{i_2, i_3}, \dots, p_{i_{m-1}, i_m}$ from left to right with the first and last vertex on the line $y=0$. So by using the shoelace formula, we can express the area of the niche $\mathcal{N}(K)$ in terms of the quadratic polynomials of the coordinates of $p_{i, j}$'s, and thus the coordinates of $\mathcal{K}_\Theta$.



The difficulty with the niche $\mathcal{N}(K)$ is that the order $\mathbf{i}_K$ of the lines appearing in the niche can change drastically depending on the cap $K$. 
We need extra restrictions on the coordinates of $K$ to ensure a fixed niche.
To this end, `SofaDesigner` builds a custom branch-and-bound tree. Initially, 

We only use the following list of inequalities for branching.

- $E_i$ : $s_i \geq 0$. 
- $L_{i, j, k}$ : The point $p_{i, j}$ is on the left side of $\mathbf{x}_k$. $p_{i, j} \cdot u_0 \leq \mathbf{x}_K \cdot u_0$
- $O_{i, j, k}$ : The point $p_{i, j}$ is on or over $l_k$. $p_{i, j} \cdot v_k \geq p_k - 1$. 

# Verifying `SofaDesigner`

`SofaDesigner` produces a branch tree $\mathcal{T}$ of the set $\mathcal{K}_\Theta$ as described above. 

To verify the branch tree, a verifier should check the followings.

1. The tree is a complete tree.
2. For each leaf node of the tree, the verifier should verify that the given $\mathbf{j}_K$ is a subset of the niche.

For every three indices $i, j, k$ appearing consecutively in order, we want to see if the vertex $p_{i, j}$ and $p_{j, k}$ is a part of the niche. If the slope of $j$ is greater than 0, then one needs to verify that $p_{i, j}$ is above the $x$-axis, $p_{i, j} \leq p_{j, k}$ in $x$-coordinates, and $p_{j, k} \leq \mathbf{x}_j = p_{j, j - n}$ in $x$-coordinates. This is sufficient. 

Write every linear constraints in the form $\geq 0$. Subtract them with nonnegative coefficients. Factor out w.r.t. D and the criticial points. The target should be of form $\mathbf{x}^T D \mathbf{x}$. Verifier should also check that $D$ is negative semidefinite.

Given a linear functional $f$ on $\mathcal{K}_\Theta$, `SofaDesigner` will be able to calculate an upper/lower bound of $f$ on $\mathcal{S}$. It will be used extensively to prove theorems like injectivity theorem.
